<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> ì¼ë³¸ì–´ ì •ë³µ ğŸ¦Š</title>
    <style>
        /* ê¸°ë³¸ ì„¤ì • */
        body {
            font-family: 'Malgun Gothic', sans-serif;
            text-align: center;
            background-color: #f0f8ff;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 90vh;
        }

        /* í™”ë©´ ì „í™˜ìš© í´ë˜ìŠ¤ */
        .screen { display: none; width: 100%; max-width: 500px; }
        .active { display: block !important; }

        h1 { color: #FF8C00; margin-bottom: 30px; line-height: 1.4; }

        /* ê³µí†µ ë²„íŠ¼ ë””ìì¸ */
        button {
            background-color: #FFD700;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 10px;
            margin: 10px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-weight: bold;
            width: 80%;
            transition: transform 0.1s;
            -webkit-tap-highlight-color: transparent;
        }
        button:active { transform: scale(0.95); }

        /* ì „ì—­ ìŒì†Œê±° ë²„íŠ¼ (z-index: 100) */
        #global-mute-btn {
            position: fixed; top: 10px; right: 10px;
            width: 50px; height: 50px; border-radius: 50%;
            padding: 0; font-size: 24px;
            background-color: white; border: 2px solid #ddd;
            z-index: 100; display: flex; align-items: center; justify-content: center;
            width: auto !important; min-width: 50px;
        }

        /* í”¼ë“œë°± ë°•ìŠ¤ (z-index: 200) */
        #feedback-box {
            position: fixed; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            width: 300px; height: 200px;
            background-color: white;
            border: 5px solid #ccc;
            border-radius: 20px;
            display: none; 
            align-items: center; justify-content: center;
            z-index: 200;
            font-size: 60px; font-weight: bold;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        /* ì˜¤ë‹µ ë…¸íŠ¸ íŒì—… ë°°ê²½ (z-index: 300) */
        #wrong-list-popup {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none;
            align-items: center; justify-content: center; 
            z-index: 300;
        }

        /* íŒì—… ì»¨í…ì¸  (í•˜ì–€ ë°•ìŠ¤) */
        .popup-content {
            background: white; padding: 20px; border-radius: 15px;
            width: 90%; max-height: 80vh; 
            text-align: center;
            position: relative;
            display: flex;      
            flex-direction: column;
            align-items: center; /* ë‹«ê¸° ë²„íŠ¼ ê°€ìš´ë° ì •ë ¬ */
        }

        /* íŒì—… ë‚´ë¶€ ìŠ¤í¬ë¡¤ ì˜ì—­ (í‘œê°€ ë“¤ì–´ê°€ëŠ” ê³³) */
        .popup-scroll-area {
            overflow-y: auto;
            flex: 1;
            margin-top: 10px;
            margin-bottom: 10px;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
            width: 100%; 
        }

        /* íŒì—… ë‹«ê¸° X ë²„íŠ¼ (ê³ ì •ë¨) */
        .btn-popup-close-x {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            width: auto !important;
            padding: 0;
            margin: 0;
            box-shadow: none;
            z-index: 10;
        }
        .btn-popup-close-x:hover { color: #ff6b6b; }

        /* í™”ë©´ë³„ ë²„íŠ¼ ìƒ‰ìƒ */
        .btn-hira { background-color: #FFD700; color: #333; height: 80px; font-size: 22px; }
        .btn-kata { background-color: #FFA500; color: white; height: 80px; font-size: 22px; }
        
        .btn-mode-study { background-color: #87CEEB; color: white; height: 80px; font-size: 22px; }
        .btn-mode-test { background-color: #FF6347; color: white; height: 80px; font-size: 22px; }
        
        /* [NEW] ê³µë¶€ ê°œìˆ˜ ì„ íƒ ë²„íŠ¼ë“¤ (ìƒ‰ìƒ ì¶”ê°€!) */
        .btn-count-20 { background-color: #20B2AA; color: white; height: 70px; font-size: 20px; } /* ì²­ë¡ìƒ‰ */
        .btn-count-30 { background-color: #FF69B4; color: white; height: 70px; font-size: 20px; } /* í•«í•‘í¬ */
        .btn-count-40 { background-color: #FF7F50; color: white; height: 70px; font-size: 20px; } /* ì½”ë„ìƒ‰ */
        .btn-count-all { background-color: #9370DB; color: white; height: 70px; font-size: 20px; } /* ë³´ë¼ìƒ‰ */

        .btn-home-small {
            position: absolute; top: 10px; left: 10px; width: auto;
            padding: 8px 15px; font-size: 14px; background-color: #ddd; color: #555;
            box-shadow: none; z-index: 10;
        }

        /* ê³µë¶€ í™”ë©´ ë²„íŠ¼ */
        .btn-sound { background-color: #87CEEB; color: white; margin-bottom: 30px; width: 60%;}
        .btn-correct { background-color: #90EE90; width: 40%; }
        .btn-wrong { background-color: #FFB6C1; width: 40%; }
        
        /* ì‹œí—˜ í™”ë©´ ë“£ê¸° ë²„íŠ¼ */
        .btn-test-sound { 
            background-color: #1E90FF; color: white; 
            width: 40%; 
            margin-top: 0px;
            margin-bottom: 30px; 
            font-size: 18px;
            padding: 10px 20px;
        }

        /* ì‹œí—˜ í™”ë©´ ì„ íƒì§€ ë²„íŠ¼ */
        .btn-option { 
            background-color: white; border: 2px solid #FF8C00; color: #333; 
            font-size: 40px; width: 30%; height: 80px; margin: 5px; padding: 0;
        }
        .options-container {
            display: flex; justify-content: center; width: 100%; margin-top: 10px;
        }

        .btn-close { background-color: #DDDDDD; width: 50%; margin-top: 20px;}

        /* ê¸€ì í¬ê¸° */
        .big-char { font-size: 120px; font-weight: bold; margin-top: 40px; margin-bottom: 10px; color: #333; }
        
        .pronunciation-text {
            font-size: 60px; font-weight: bold; color: #555; height: 70px;
            margin-bottom: 20px; visibility: hidden;
        }

        .test-question { font-size: 80px; font-weight: bold; color: #FF6347; margin-top: 30px; margin-bottom: 10px; }
        
        .score-text { font-size: 60px; font-weight: bold; color: #1E90FF; margin: 20px 0; }
        .info-text { font-size: 18px; color: #555; margin-bottom: 10px; }
        .grade-msg { font-size: 24px; font-weight: bold; margin: 15px 0; min-height: 30px; }

        /* í…Œì´ë¸” */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ddd; padding: 15px; font-size: 24px; text-align: center; }
        th { background-color: #FF8C00; color: white; }
    </style>
</head>
<body>

    <button id="global-mute-btn" onclick="toggleGlobalMute()">ğŸ”Š</button>

    <div id="feedback-box"></div>

    <div id="start-screen" class="screen active">
        <h1>ì¼ë³¸ì–´ ë¬¸ì<br>ì™„ì „ ì •ë³µ ğŸ¦Š</h1>
        <p class="info-text">ì–´ë–¤ ë¬¸ìë¥¼ ê³µë¶€í• ê¹Œìš”?</p>
        <button class="btn-hira" onclick="selectCharType('hiragana')">íˆë¼ê°€ë‚˜ (ã‚)</button>
        <button class="btn-kata" onclick="selectCharType('katakana')">ì¹´íƒ€ì¹´ë‚˜ (ã‚¢)</button>
    </div>

    <div id="mode-select-screen" class="screen">
        <button class="btn-home-small" onclick="goHome()">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>
        <h1 id="selected-mode-title">íˆë¼ê°€ë‚˜</h1>
        <p class="info-text">í•™ìŠµ ë°©ì‹ì„ ì„ íƒí•˜ì„¸ìš”!</p>
        <button class="btn-mode-study" onclick="gotoQuantitySelect()">ğŸ“– ê³µë¶€í•˜ê¸°<br><span style="font-size:14px">(ì¹´ë“œ ë’¤ì§‘ê¸°)</span></button>
        <button class="btn-mode-test" onclick="startTest()">ğŸ“ ì‹œí—˜ë³´ê¸°<br><span style="font-size:14px">(20ë¬¸ì œ ê°ê´€ì‹)</span></button>
    </div>

    <div id="quantity-select-screen" class="screen">
        <button class="btn-home-small" onclick="goHome()">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>
        <h1 style="color:#87CEEB">ê³µë¶€ ë²”ìœ„ ì„ íƒ</h1>
        <p class="info-text">ëª‡ ê°œì˜ ë‹¨ì–´ë¥¼ ê³µë¶€í• ê¹Œìš”?</p>
        
        <button class="btn-count-20" onclick="startStudy('20')">ğŸŒ± 20ê°œë§Œ í•˜ê¸°<br><span style="font-size:14px">(ê°€ë³ê²Œ ì‹œì‘)</span></button>
        <button class="btn-count-30" onclick="startStudy('30')">ğŸµ 30ê°œë§Œ í•˜ê¸°<br><span style="font-size:14px">(ì ë‹¹íˆ)</span></button>
        <button class="btn-count-40" onclick="startStudy('40')">ğŸ”¥ 40ê°œ ë„ì „<br><span style="font-size:14px">(ì—´ì‹¬íˆ)</span></button>
        <button class="btn-count-all" onclick="startStudy('all')">ğŸ‘‘ ì „ì²´ ë‹¤ í•˜ê¸°<br><span style="font-size:14px">(71ê°œ ëª¨ë‘)</span></button>
    </div>

    <div id="study-screen" class="screen">
        <button class="btn-home-small" onclick="goHome()">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>

        <div class="info-text" style="margin-top: 40px; font-weight:bold; color:#FF8C00;">ê³µë¶€ ëª¨ë“œ</div>
        <div id="study-progress" class="info-text">1 / 46</div>
        
        <div id="char-display" class="big-char">ã‚</div>
        <div id="pronunciation-display" class="pronunciation-text">a</div>

        <button class="btn-sound" onclick="playSoundAndShowText()">ğŸ”Š ë°œìŒ/ì •ë‹µ ë³´ê¸°</button>
        
        <div style="display: flex; justify-content: center; gap: 10px;">
            <button class="btn-correct" onclick="checkStudyAnswer(true)">ì•Œì•„ìš”!</button>
            <button class="btn-wrong" onclick="checkStudyAnswer(false)">ëª°ë¼ìš”...</button>
        </div>
    </div>

    <div id="test-screen" class="screen">
        <button class="btn-home-small" onclick="goHome()">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>

        <div class="info-text" style="margin-top: 40px; font-weight:bold; color:#FF6347;">ì‹œí—˜ ëª¨ë“œ (20ë¬¸ì œ)</div>
        <div id="test-progress" class="info-text">1 / 20</div>
        
        <p class="info-text">ë°œìŒì„ ë“£ê³  ë§ëŠ” ê¸€ìë¥¼ ê³ ë¥´ì„¸ìš”!</p>
        
        <div id="test-question-text" class="test-question">a</div>

        <button class="btn-test-sound" onclick="playTestSound()">ğŸ”Š ë°œìŒ ë“£ê¸°</button>

        <div class="options-container" id="options-container">
            </div>
    </div>

    <div id="result-screen" class="screen">
        <h1>ê²°ê³¼ ë°œí‘œ!</h1>
        
        <div id="score-count" class="info-text">ë§ì€ ê°œìˆ˜: 0 / 0</div>
        <div id="grade-msg" class="grade-msg"></div>
        <div id="final-score" class="score-text">0 ì </div>
        
        <div id="wrong-msg" style="display:none; margin-top:20px;">
            <button style="background-color: #FFB6C1;" onclick="openWrongList()">ì˜¤ë‹µ ëª©ë¡ ë³´ê¸°</button>
        </div>

        <button style="background-color: #DDDDDD;" onclick="showScreen('start-screen')">ì²˜ìŒìœ¼ë¡œ</button>
    </div>

    <div id="wrong-list-popup">
        <div class="popup-content">
            <button class="btn-popup-close-x" onclick="closeWrongList()">âœ•</button>
            
            <h2>ì˜¤ë‹µ ë…¸íŠ¸</h2>
            <p id="wrong-count-display" style="color: red; font-weight: bold;">ì´ 0ê°œ í‹€ë¦¼</p>
            
            <div class="popup-scroll-area">
                <table id="wrong-table">
                    <thead>
                        <tr><th>ê¸€ì</th><th>ë°œìŒ</th></tr>
                    </thead>
                    <tbody id="wrong-table-body">
                    </tbody>
                </table>
            </div>

            <button class="btn-close" onclick="closeWrongList()">ë‹«ê¸° (Close)</button>
        </div>
    </div>

    <script>
        // --- ë°ì´í„° ---
        const hiraganaData = {
            'ã‚': 'a', 'ã„': 'i', 'ã†': 'u', 'ãˆ': 'e', 'ãŠ': 'o',
            'ã‹': 'ka', 'ã': 'ki', 'ã': 'ku', 'ã‘': 'ke', 'ã“': 'ko',
            'ã•': 'sa', 'ã—': 'shi', 'ã™': 'su', 'ã›': 'se', 'ã': 'so',
            'ãŸ': 'ta', 'ã¡': 'chi', 'ã¤': 'tsu', 'ã¦': 'te', 'ã¨': 'to',
            'ãª': 'na', 'ã«': 'ni', 'ã¬': 'nu', 'ã­': 'ne', 'ã®': 'no',
            'ã¯': 'ha', 'ã²': 'hi', 'ãµ': 'fu', 'ã¸': 'he', 'ã»': 'ho',
            'ã¾': 'ma', 'ã¿': 'mi', 'ã‚€': 'mu', 'ã‚': 'me', 'ã‚‚': 'mo',
            'ë‚˜': 'na', 'ë‹ˆ': 'ni', 'ëˆ„': 'nu', 'ë„¤': 'ne', 'ë…¸': 'no',
            'ã‚„': 'ya', 'ã‚†': 'yu', 'ã‚ˆ': 'yo',
            'ã‚‰': 'ra', 'ã‚Š': 'ri', 'ã‚‹': 'ru', 'ã‚Œ': 're', 'ã‚': 'ro',
            'ã‚': 'wa', 'ã‚’': 'wo', 'ã‚“': 'n',
            'ãŒ': 'ga', 'ã': 'gi', 'ã': 'gu', 'ã’': 'ge', 'ã”': 'go',
            'ã–': 'za', 'ã˜': 'ji', 'ãš': 'zu', 'ãœ': 'ze', 'ã': 'zo',
            'ë‹¤': 'da', 'ã¢': 'ji', 'ã¥': 'zu', 'ã§': 'de', 'ë„': 'do',
            'ã°': 'ba', 'ã³': 'bi', 'ã¶': 'bu', 'ã¹': 'be', 'ã¼': 'bo',
            'ã±': 'pa', 'ã´': 'pi', 'ã·': 'pu', 'ãº': 'pe', 'ã½': 'po',
            'ë¡œ': 'de', 'ë„': 'do', 'ã«': 'ni', 'ã ': 'da'
        };

        const katakanaData = {
            'ã‚¢': 'a', 'ã‚¤': 'i', 'ã‚¦': 'u', 'ã‚¨': 'e', 'ã‚ª': 'o',
            'ã‚«': 'ka', 'ã‚­': 'ki', 'ã‚¯': 'ku', 'ã‚±': 'ke', 'ã‚³': 'ko',
            'ã‚µ': 'sa', 'ã‚·': 'shi', 'ã‚¹': 'su', 'ã‚»': 'se', 'ã‚½': 'so',
            'ã‚¿': 'ta', 'ãƒ': 'chi', 'ãƒ„': 'tsu', 'ãƒ†': 'te', 'ãƒˆ': 'to',
            'ãƒŠ': 'na', 'ãƒ‹': 'ni', 'ãƒŒ': 'nu', 'ãƒ': 'ne', 'ãƒ': 'no',
            'ãƒ': 'ha', 'ãƒ’': 'hi', 'ãƒ•': 'fu', 'ãƒ˜': 'he', 'ãƒ›': 'ho',
            'ãƒ': 'ma', 'ãƒŸ': 'mi', 'ãƒ ': 'mu', 'ãƒ¡': 'me', 'ãƒ¢': 'mo',
            'ãƒ¤': 'ya', 'ãƒ¦': 'yu', 'ãƒ¨': 'yo',
            'ãƒ©': 'ra', 'ãƒª': 'ri', 'ãƒ«': 'ru', 'ãƒ¬': 're', 'ãƒ­': 'ro',
            'ãƒ¯': 'wa', 'ãƒ²': 'wo', 'ãƒ³': 'n',
            'ã‚¬': 'ga', 'ã‚®': 'gi', 'ã‚°': 'gu', 'ã‚²': 'ge', 'ã‚´': 'go',
            'ã‚¶': 'za', 'ã‚¸': 'ji', 'ã‚º': 'zu', 'ã‚¼': 'ze', 'ã‚¾': 'zo',
            'ãƒ€': 'da', 'ãƒ‚': 'ji', 'ãƒ…': 'zu', 'ãƒ‡': 'de', 'ãƒ‰': 'do',
            'ãƒ': 'ba', 'ãƒ“': 'bi', 'ãƒ–': 'bu', 'ãƒ™': 'be', 'ãƒœ': 'bo',
            'ãƒ‘': 'pa', 'ãƒ”': 'pi', 'ãƒ—': 'pu', 'ãƒš': 'pe', 'ãƒ': 'po'
        };

        const cleanHiragana = {};
        for(let k in hiraganaData) {
            if(k.match(/[ã-ã‚“]/)) cleanHiragana[k] = hiraganaData[k];
        }
        const cleanKatakana = {};
        for(let k in katakanaData) {
            if(k.match(/[ã‚¡-ãƒ³]/)) cleanKatakana[k] = katakanaData[k];
        }


        // --- ìƒíƒœ ë³€ìˆ˜ ---
        let currentMode = ''; 
        let currentModeData = {};
        let studyType = ''; 
        let quizList = []; 
        let wrongList = []; 
        let currentIndex = 0;
        let score = 0;
        const TEST_QUESTION_COUNT = 20;
        let isMuted = false;
        let isProcessing = false; 
        
        let currentTestChar = '';

        // --- ì†Œë¦¬ ê´€ë ¨ ---
        function toggleGlobalMute() {
            isMuted = !isMuted;
            const btn = document.getElementById('global-mute-btn');
            if (isMuted) {
                btn.innerText = 'ğŸ”‡';
                if(window.speechSynthesis) window.speechSynthesis.cancel();
            } else {
                btn.innerText = 'ğŸ”Š';
            }
        }

        function speakText(text) {
            if (isMuted) return;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ja-JP';
            utterance.rate = 0.8;
            window.speechSynthesis.speak(utterance);
        }

        // --- í™”ë©´ ì „í™˜ ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function goHome() {
            if(confirm("ì •ë§ ì²˜ìŒ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°ˆê¹Œìš”?")) {
                showScreen('start-screen');
                if(window.speechSynthesis) window.speechSynthesis.cancel();
            }
        }

        // --- ë¡œì§ ---
        function selectCharType(type) {
            currentMode = type;
            if (type === 'hiragana') {
                currentModeData = cleanHiragana;
                document.getElementById('selected-mode-title').innerText = "íˆë¼ê°€ë‚˜";
            } else {
                currentModeData = cleanKatakana;
                document.getElementById('selected-mode-title').innerText = "ì¹´íƒ€ì¹´ë‚˜";
            }
            showScreen('mode-select-screen');
        }

        // --- ê³µë¶€ ëª¨ë“œ ---
        function gotoQuantitySelect() {
            showScreen('quantity-select-screen');
        }

        // [ê³µë¶€ ëª¨ë“œ ì‹œì‘ í•¨ìˆ˜]
        // amount: ëª‡ ê°œë¥¼ ê³µë¶€í• ì§€ ì •í•˜ëŠ” ì£¼ë¬¸í‘œì˜ˆìš” ('all' ë˜ëŠ” '10', '30' ê°™ì€ ìˆ«ì)
        function startStudy(amount) {
            // 1. í˜„ì¬ ëª¨ë“œë¥¼ 'ê³µë¶€(study)'ë¡œ ì„¤ì •í•´ìš” (ì‹œí—˜ ëª¨ë“œë‘ êµ¬ë¶„í•˜ê¸° ìœ„í•´)
            studyType = 'study';

            // 2. í˜„ì¬ ì„ íƒëœ ëª¨ë“œ(íˆë¼ê°€ë‚˜/ì¹´íƒ€ì¹´ë‚˜)ì˜ ëª¨ë“  ê¸€ìë¥¼ ê°€ì ¸ì™€ìš”
            const allChars = Object.keys(currentModeData);
            
            // 3. ê¸€ìë“¤ì˜ ìˆœì„œë¥¼ ë¬´ì‘ìœ„ë¡œ ë’¤ì„ì–´ìš” (ë§¤ë²ˆ ìƒˆë¡œìš´ ìˆœì„œ!)
            allChars.sort(() => Math.random() - 0.5);

            // 4. ì£¼ë¬¸(amount)ì— ë”°ë¼ ê³µë¶€í•  ë¬¸ì œ ëª©ë¡(quizList)ì„ ë§Œë“¤ì–´ìš”
            if (amount === 'all') {
                // 'all'ì´ë©´ ì„ì€ ê¸€ì ì „ì²´ë¥¼ ë‹¤ ë„£ì–´ìš”
                quizList = allChars; 
            } else {
                // ìˆ«ìê°€ ë“¤ì–´ì˜¤ë©´(ì˜ˆ: '30'), ê·¸ ìˆ«ìë§Œí¼ë§Œ ì•ì—ì„œ ì˜ë¼ì„œ ë„£ì–´ìš”
                // parseInt(amount)ëŠ” ë¬¸ì '30'ì„ ì§„ì§œ ìˆ«ì 30ìœ¼ë¡œ ë°”ê¿”ì£¼ëŠ” ê¸°ëŠ¥ì´ì—ìš”!
                const count = parseInt(amount); 
                quizList = allChars.slice(0, count); 
            }
            
            // 5. ì ìˆ˜ì™€ ì§„í–‰ ìƒí™©ì„ ì´ˆê¸°í™”í•´ìš” (ìƒˆ ê²Œì„ ì¤€ë¹„!)
            wrongList = [];   // í‹€ë¦° ëª©ë¡ ë¹„ìš°ê¸°
            currentIndex = 0; // ì²« ë²ˆì§¸ ë¬¸ì œë¶€í„° ì‹œì‘
            score = 0;        // ì ìˆ˜ 0ì 
            
            // 6. ì²« ë²ˆì§¸ ë¬¸ì œ í™”ë©´ì„ êµ¬ì„±í•˜ê³  ë³´ì—¬ì¤˜ìš”
            updateStudyScreen();        // í™”ë©´ ê¸€ì ì—…ë°ì´íŠ¸
            showScreen('study-screen'); // ê³µë¶€ í™”ë©´ìœ¼ë¡œ ì´ë™
        }

        function updateStudyScreen() {
            if (currentIndex >= quizList.length) {
                finishGame();
                return;
            }
            const char = quizList[currentIndex];
            document.getElementById('char-display').innerText = char;
            document.getElementById('study-progress').innerText = `${currentIndex + 1} / ${quizList.length}`;
            
            const pDisplay = document.getElementById('pronunciation-display');
            pDisplay.style.visibility = 'hidden'; 
            pDisplay.innerText = '';
        }

        function playSoundAndShowText() {
            const char = quizList[currentIndex];
            const pronunciation = currentModeData[char];
            
            const pDisplay = document.getElementById('pronunciation-display');
            pDisplay.innerText = pronunciation;
            pDisplay.style.visibility = 'visible';

            speakText(char);
        }

        function checkStudyAnswer(isCorrect) {
            const char = quizList[currentIndex];
            if (isCorrect) score++;
            else wrongList.push(char);
            
            currentIndex++;
            updateStudyScreen();
        }

        // --- ì‹œí—˜ ëª¨ë“œ ---
        function startTest() {
            studyType = 'test';
            isProcessing = false;
            const allChars = Object.keys(currentModeData);
            
            quizList = [];
            const tempChars = [...allChars].sort(() => Math.random() - 0.5);
            quizList = tempChars.slice(0, TEST_QUESTION_COUNT); 
            
            wrongList = [];
            currentIndex = 0;
            score = 0;
            
            renderTestQuestion();
            showScreen('test-screen');
        }

        function renderTestQuestion() {
            if (currentIndex >= quizList.length) {
                finishGame();
                return;
            }

            isProcessing = false; 
            const correctChar = quizList[currentIndex];
            const correctPronunciation = currentModeData[correctChar];
            const allChars = Object.keys(currentModeData);

            currentTestChar = correctChar; 
            
            document.getElementById('test-question-text').innerText = correctPronunciation;
            document.getElementById('test-progress').innerText = `${currentIndex + 1} / ${TEST_QUESTION_COUNT}`;

            let options = [correctChar];
            while (options.length < 3) {
                const randomChar = allChars[Math.floor(Math.random() * allChars.length)];
                if (!options.includes(randomChar)) {
                    options.push(randomChar);
                }
            }
            options.sort(() => Math.random() - 0.5);

            const container = document.getElementById('options-container');
            container.innerHTML = '';

            options.forEach(char => {
                const btn = document.createElement('button');
                btn.className = 'btn-option';
                btn.innerText = char;
                btn.onclick = () => checkTestAnswer(char, correctChar);
                container.appendChild(btn);
            });
        }

        function playTestSound() {
            if(currentTestChar) {
                speakText(currentTestChar);
            }
        }

        function checkTestAnswer(selectedChar, correctChar) {
            if (isProcessing) return; 
            isProcessing = true;

            const isCorrect = (selectedChar === correctChar);
            
            if (isCorrect) {
                score++;
                showFeedback(true);
            } else {
                wrongList.push(correctChar);
                showFeedback(false);
            }

            setTimeout(() => {
                currentIndex++;
                renderTestQuestion();
            }, 800); 
        }

        function showFeedback(isCorrect) {
            const box = document.getElementById('feedback-box');
            if (isCorrect) {
                box.innerText = "ì •ë‹µ! â­•";
                box.style.color = "green";
                box.style.borderColor = "green";
            } else {
                box.innerText = "ë•¡! âŒ";
                box.style.color = "red";
                box.style.borderColor = "red";
            }
            
            box.style.display = 'flex'; 
            
            setTimeout(() => {
                box.style.display = 'none';
            }, 800);
        }

        // --- ê²°ê³¼ í™”ë©´ ---
        function finishGame() {
            if(window.speechSynthesis) window.speechSynthesis.cancel();
            
            const total = quizList.length;
            const finalScore = total === 0 ? 0 : Math.round((score / total) * 100);

            document.getElementById('score-count').innerText = `ë§ì€ ê°œìˆ˜: ${score} / ${total}`;
            
            let message = "";
            let color = "#333";

            if (finalScore === 100) {
                message = "ì™„ë²½í•´ìš”! ë‹¹ì‹ ì€ ì¼ë³¸ì–´ ì²œì¬ì•¼! ğŸ‰";
                color = "#32CD32";
            } else if (finalScore >= 80) {
                message = "ëŒ€ë‹¨í•´! ì•„ì£¼ ì¡°ê¸ˆë§Œ ë” í•˜ë©´ ë§Œì ì´ì•¼! ğŸ”¥";
                color = "#1E90FF";
            } else if (finalScore >= 60) {
                message = "ì˜í–ˆì–´! í•©ê²©ì ì´ì•¼! ğŸ‘";
                color = "#00CED1";
            } else if (finalScore >= 40) {
                message = "ì ˆë°˜ì€ ë„˜ì—ˆì–´! ì¡°ê¸ˆë§Œ ë” í˜ë‚´ì! ğŸ’ª";
                color = "#FFA500";
            } else if (finalScore >= 20) {
                message = "ì•„ì§ í—·ê°ˆë¦¬ëŠ” ê²Œ ë§êµ¬ë‚˜... ë³µìŠµ í•„ìˆ˜! ğŸ“š";
                color = "#FF6347";
            } else if (finalScore > 0) {
                message = "ì´ì œ ì‹œì‘ì´ì•¼! í¬ê¸°í•˜ì§€ ë§ˆ! ğŸŒ±";
                color = "#FF4500";
            } else {
                message = "0ì ì´ë¼ë‹ˆ... ì°ì–´ë„ ì´ê²ƒë³´ë‹¨ ì˜ ë‚˜ì˜¤ê² ë‹¤! ğŸ˜­";
                color = "red";
            }

            const gradeMsg = document.getElementById('grade-msg');
            gradeMsg.innerText = message;
            gradeMsg.style.color = color;

            document.getElementById('final-score').innerText = `${finalScore} ì `;

            if (wrongList.length > 0) {
                document.getElementById('wrong-msg').style.display = 'block';
            } else {
                document.getElementById('wrong-msg').style.display = 'none';
            }
            showScreen('result-screen');
        }

        // [ì˜¤ë‹µ ë…¸íŠ¸ íŒì—… ì—´ê¸° í•¨ìˆ˜]
        function openWrongList() {
            const tbody = document.getElementById('wrong-table-body');
            tbody.innerHTML = '';
            
            document.getElementById('wrong-count-display').innerText = `ì´ ${wrongList.length}ê°œ í‹€ë¦¼`;

            wrongList.forEach(char => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${char}</td><td>${currentModeData[char]}</td>`;
                tbody.appendChild(tr);
            });

            // 1. ë¨¼ì € ì°½ì„ í™”ë©´ì— ë„ì›Œìš”!
            document.getElementById('wrong-list-popup').style.display = 'flex';

            // 2. ê·¸ ë‹¤ìŒì— ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ ì˜¬ë ¤ìš”!
            document.querySelector('.popup-scroll-area').scrollTop = 0;
        }

        function closeWrongList() {
            document.getElementById('wrong-list-popup').style.display = 'none';
        }
    </script>
</body>
</html>