<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> ì¼ë³¸ì–´ ì •ë³µ ğŸ¦Š</title>
    <style>
        /* ê¸°ë³¸ ì„¤ì • */
        body {
            font-family: 'Malgun Gothic', sans-serif;
            text-align: center;
            background-color: #f0f8ff;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 90vh;
        }

        .screen { display: none; width: 100%; max-width: 500px; }
        .active { display: block !important; }

        h1 { color: #FF8C00; margin-bottom: 30px; line-height: 1.4; }

        button {
            background-color: #FFD700;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 10px;
            margin: 10px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-weight: bold;
            width: 80%;
            transition: transform 0.1s;
            -webkit-tap-highlight-color: transparent;
        }
        button:active { transform: scale(0.95); }

        #global-mute-btn {
            position: fixed; top: 10px; right: 10px;
            width: 50px; height: 50px; border-radius: 50%;
            padding: 0; font-size: 24px;
            background-color: white; border: 2px solid #ddd;
            z-index: 100; display: flex; align-items: center; justify-content: center;
            width: auto !important; min-width: 50px;
        }

        #feedback-box {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; height: 200px; background-color: white;
            border: 5px solid #ccc; border-radius: 20px;
            display: none; align-items: center; justify-content: center;
            z-index: 200; font-size: 60px; font-weight: bold;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        #wrong-list-popup {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none;
            align-items: center; justify-content: center; z-index: 300;
        }

        .popup-content {
            background: white; padding: 20px; border-radius: 15px;
            width: 90%; max-height: 80vh; text-align: center;
            position: relative; display: flex; flex-direction: column;
            align-items: center;
        }

        .popup-scroll-area {
            overflow-y: auto; flex: 1; margin: 10px 0;
            border-top: 1px solid #eee; border-bottom: 1px solid #eee; width: 100%;
        }

        .btn-popup-close-x {
            position: absolute; top: 15px; right: 20px;
            background: none; border: none; font-size: 28px;
            font-weight: bold; color: #aaa; cursor: pointer;
            width: auto !important; padding: 0; margin: 0; box-shadow: none; z-index: 10;
        }

        /* ë²„íŠ¼ ìƒ‰ìƒ */
        .btn-hira { background-color: #FFD700; color: #333; height: 80px; font-size: 22px; }
        .btn-kata { background-color: #FFA500; color: white; height: 80px; font-size: 22px; }
        .btn-sheet { background-color: #4CAF50; color: white; height: 80px; font-size: 22px; }
        
        .btn-mode-study { background-color: #87CEEB; color: white; height: 80px; font-size: 22px; }
        .btn-mode-test { background-color: #FF6347; color: white; height: 80px; font-size: 22px; }
        
        .btn-count-20 { background-color: #20B2AA; color: white; height: 70px; font-size: 20px; }
        .btn-count-30 { background-color: #FF69B4; color: white; height: 70px; font-size: 20px; }
        .btn-count-40 { background-color: #FF7F50; color: white; height: 70px; font-size: 20px; }
        .btn-count-all { background-color: #9370DB; color: white; height: 70px; font-size: 20px; }

        .btn-home-small {
            position: absolute; top: 10px; left: 10px; width: auto;
            padding: 8px 15px; font-size: 14px; background-color: #ddd; color: #555;
            box-shadow: none; z-index: 10;
        }

        .btn-sound { background-color: #87CEEB; color: white; margin-bottom: 30px; width: 60%;}
        .btn-correct { background-color: #90EE90; width: 40%; }
        .btn-wrong { background-color: #FFB6C1; width: 40%; }
        
        .btn-test-sound { 
            background-color: #1E90FF; color: white; width: 40%; 
            margin-top: 0px; margin-bottom: 30px; font-size: 18px; padding: 10px 20px;
        }

        .btn-option { 
            background-color: white; border: 2px solid #FF8C00; color: #333; 
            font-size: 22px; /* ë‹¨ì–´ ëœ»ì´ ê¸¸ì–´ì§ˆ ìˆ˜ ìˆì–´ì„œ ì¡°ì ˆ */
            width: 30%; height: 100px; /* ë†’ì´ ì¡°ê¸ˆ í‚¤ì›€ */
            margin: 5px; padding: 5px;
            overflow: hidden; text-overflow: ellipsis; 
            display: flex; align-items: center; justify-content: center;
            word-break: keep-all; line-height: 1.2;
        }
        .options-container { display: flex; justify-content: center; width: 100%; margin-top: 10px; }
        .btn-close { background-color: #DDDDDD; width: 50%; margin-top: 20px;}

        /* [NEW] ë¬¸ì œ í‘œì‹œ ìŠ¤íƒ€ì¼ (ë°œìŒ ì‘ê²Œ, ì¼ë³¸ì–´ í¬ê²Œ) */
        .question-container { margin-top: 30px; margin-bottom: 10px; }
        .pron-small { font-size: 30px; color: #888; margin-bottom: 5px; min-height: 40px;}
        .jp-big { font-size: 70px; font-weight: bold; color: #333; line-height: 1.1; word-break: keep-all;}
        
        /* ê³µë¶€ ëª¨ë“œì—ì„œ ë³´ì—¬ì¤„ í…ìŠ¤íŠ¸ */
        .meaning-text { font-size: 40px; font-weight: bold; color: #1E90FF; margin: 20px 0; visibility: hidden; }

        .score-text { font-size: 60px; font-weight: bold; color: #1E90FF; margin: 20px 0; }
        .info-text { font-size: 18px; color: #555; margin-bottom: 10px; }
        .grade-msg { font-size: 24px; font-weight: bold; margin: 15px 0; min-height: 30px; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ddd; padding: 15px; font-size: 18px; text-align: center; }
        th { background-color: #FF8C00; color: white; }
        
        #loading-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.9); z-index: 500;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

    <button id="global-mute-btn" onclick="toggleGlobalMute()">ğŸ”Š</button>
    <div id="feedback-box"></div>

    <div id="loading-screen">
        <h2>ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” ì¤‘... ğŸ¦Š</h2>
        <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!</p>
    </div>

    <div id="start-screen" class="screen active">
        <h1>ì¼ë³¸ì–´ ë¬¸ì & ë‹¨ì–´<br>ì™„ì „ ì •ë³µ ğŸ¦Š</h1>
        <p class="info-text">ê³µë¶€í•  ë‚´ìš©ì„ ì„ íƒí•˜ì„¸ìš”!</p>
        <button class="btn-hira" onclick="selectCharType('hiragana')">íˆë¼ê°€ë‚˜ (ã‚)</button>
        <button class="btn-kata" onclick="selectCharType('katakana')">ì¹´íƒ€ì¹´ë‚˜ (ã‚¢)</button>
        <button class="btn-sheet" onclick="loadSheetData()">ğŸ“„ êµ¬ê¸€ ì‹œíŠ¸ ë‹¨ì–´ì¥</button>
    </div>

    <div id="mode-select-screen" class="screen">
        <button class="btn-home-small" onclick="goHome()">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>
        <h1 id="selected-mode-title">íˆë¼ê°€ë‚˜</h1>
        <p class="info-text">í•™ìŠµ ë°©ì‹ì„ ì„ íƒí•˜ì„¸ìš”!</p>
        <button class="btn-mode-study" onclick="gotoQuantitySelect()">ğŸ“– ê³µë¶€í•˜ê¸°<br><span style="font-size:14px">(ì¹´ë“œ ë’¤ì§‘ê¸°)</span></button>
        <button class="btn-mode-test" onclick="startTest()">ğŸ“ ì‹œí—˜ë³´ê¸°<br><span style="font-size:14px">(ê°ê´€ì‹ í…ŒìŠ¤íŠ¸)</span></button>
    </div>

    <div id="quantity-select-screen" class="screen">
        <button class="btn-home-small" onclick="goHome()">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>
        <h1 style="color:#87CEEB">ê³µë¶€ ë²”ìœ„ ì„ íƒ</h1>
        <p class="info-text">ëª‡ ê°œì˜ ë‹¨ì–´ë¥¼ ê³µë¶€í• ê¹Œìš”?</p>
        <button class="btn-count-20" onclick="startStudy('20')">ğŸŒ± 20ê°œë§Œ í•˜ê¸°</button>
        <button class="btn-count-30" onclick="startStudy('30')">ğŸµ 30ê°œë§Œ í•˜ê¸°</button>
        <button class="btn-count-40" onclick="startStudy('40')">ğŸ”¥ 40ê°œ ë„ì „</button>
        <button class="btn-count-all" onclick="startStudy('all')">ğŸ‘‘ ì „ì²´ ë‹¤ í•˜ê¸°</button>
    </div>

    <div id="study-screen" class="screen">
        <button class="btn-home-small" onclick="goHome()">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>
        <div class="info-text" style="margin-top: 40px; font-weight:bold; color:#FF8C00;">ê³µë¶€ ëª¨ë“œ</div>
        <div id="study-progress" class="info-text">1 / 46</div>
        
        <div class="question-container">
            <div id="study-pron" class="pron-small"></div>
            <div id="study-jp" class="jp-big"></div>
        </div>
        
        <div id="study-meaning" class="meaning-text">ëœ»</div>

        <button class="btn-sound" onclick="playSoundAndShowText()">ğŸ”Š ë°œìŒ/ëœ» ë³´ê¸°</button>
        <div style="display: flex; justify-content: center; gap: 10px;">
            <button class="btn-correct" onclick="checkStudyAnswer(true)">ì•Œì•„ìš”!</button>
            <button class="btn-wrong" onclick="checkStudyAnswer(false)">ëª°ë¼ìš”...</button>
        </div>
    </div>

    <div id="test-screen" class="screen">
        <button class="btn-home-small" onclick="goHome()">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>
        <div class="info-text" style="margin-top: 40px; font-weight:bold; color:#FF6347;">ì‹œí—˜ ëª¨ë“œ (20ë¬¸ì œ)</div>
        <div id="test-progress" class="info-text">1 / 20</div>
        
        <p class="info-text">ë‹¤ìŒ ë‹¨ì–´ì˜ ëœ»ì€?</p>
        
        <div class="question-container">
            <div id="test-pron" class="pron-small">pron</div>
            <div id="test-jp" class="jp-big">Japan</div>
        </div>

        <button class="btn-test-sound" onclick="playTestSound()">ğŸ”Š ë°œìŒ ë“£ê¸°</button>
        <div class="options-container" id="options-container"></div>
    </div>

    <div id="result-screen" class="screen">
        <h1>ê²°ê³¼ ë°œí‘œ!</h1>
        <div id="score-count" class="info-text">ë§ì€ ê°œìˆ˜: 0 / 0</div>
        <div id="grade-msg" class="grade-msg"></div>
        <div id="final-score" class="score-text">0 ì </div>
        <div id="wrong-msg" style="display:none; margin-top:20px;">
            <button style="background-color: #FFB6C1;" onclick="openWrongList()">ì˜¤ë‹µ ëª©ë¡ ë³´ê¸°</button>
        </div>
        <button style="background-color: #DDDDDD;" onclick="showScreen('start-screen')">ì²˜ìŒìœ¼ë¡œ</button>
    </div>

    <div id="wrong-list-popup">
        <div class="popup-content">
            <button class="btn-popup-close-x" onclick="closeWrongList()">âœ•</button>
            <h2>ì˜¤ë‹µ ë…¸íŠ¸</h2>
            <p id="wrong-count-display" style="color: red; font-weight: bold;">ì´ 0ê°œ í‹€ë¦¼</p>
            <div class="popup-scroll-area">
                <table id="wrong-table">
                    <thead><tr><th>ë‹¨ì–´</th><th>ë°œìŒ</th><th>ëœ»</th></tr></thead>
                    <tbody id="wrong-table-body"></tbody>
                </table>
            </div>
            <button class="btn-close" onclick="closeWrongList()">ë‹«ê¸° (Close)</button>
        </div>
    </div>

    <script>
        // ============================================================
        // [ì¤‘ìš”] ì—¬ê¸°ì— êµ¬ê¸€ ì‹œíŠ¸ CSV ë§í¬ë¥¼ ë„£ì–´ì£¼ì„¸ìš”!
        // ============================================================
        const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGxiRP3J-FthdSErZu8BhWc85O2_eeOGqYaX_YILIqoB0HbZBGkLFsOCsoe55-0ZTzVKLxpicjie4n/pub?gid=0&single=true&output=csv";
        // ============================================================

        // ê¸°ë³¸ ë°ì´í„° (íˆë¼ê°€ë‚˜/ì¹´íƒ€ì¹´ë‚˜) - êµ¬ì¡°ë¥¼ {jp, pron, mean}ìœ¼ë¡œ í†µì¼
        // íˆë¼ê°€ë‚˜/ì¹´íƒ€ì¹´ë‚˜ëŠ” 'ëœ»'ì´ ê·¸ëƒ¥ ë°œìŒê³¼ ê°™ìŒ
        const hiraganaRaw = {
            'ã‚':'a','ã„':'i','ã†':'u','ãˆ':'e','ãŠ':'o','ã‹':'ka','ã':'ki','ã':'ku','ã‘':'ke','ã“':'ko','ã•':'sa','ã—':'shi','ã™':'su','ã›':'se','ã':'so','ãŸ':'ta','ã¡':'chi','ã¤':'tsu','ã¦':'te','ã¨':'to','ãª':'na','ã«':'ni','ã¬':'nu','ã­':'ne','ã®':'no','ã¯':'ha','ã²':'hi','ãµ':'fu','ã¸':'he','ã»':'ho','ã¾':'ma','ã¿':'mi','ã‚€':'mu','ã‚':'me','ã‚‚':'mo','ã‚„':'ya','ã‚†':'yu','ã‚ˆ':'yo','ã‚‰':'ra','ã‚Š':'ri','ã‚‹':'ru','ã‚Œ':'re','ã‚':'ro','ã‚':'wa','ã‚’':'wo','ã‚“':'n',
            'ãŒ':'ga','ã':'gi','ã':'gu','ã’':'ge','ã”':'go','ã–':'za','ã˜':'ji','ãš':'zu','ãœ':'ze','ã':'zo','ã ':'da','ã¢':'ji','ã¥':'zu','ã§':'de','ã©':'do','ã°':'ba','ã³':'bi','ã¶':'bu','ã¹':'be','ã¼':'bo','ã±':'pa','ã´':'pi','ã·':'pu','ãº':'pe','ã½':'po'
        };
        const katakanaRaw = {
            'ã‚¢':'a','ã‚¤':'i','ã‚¦':'u','ã‚¨':'e','ã‚ª':'o','ã‚«':'ka','ã‚­':'ki','ã‚¯':'ku','ã‚±':'ke','ã‚³':'ko','ã‚µ':'sa','ã‚·':'shi','ã‚¹':'su','ã‚»':'se','ã‚½':'so','ã‚¿':'ta','ãƒ':'chi','ãƒ„':'tsu','ãƒ†':'te','ãƒˆ':'to','ãƒŠ':'na','ãƒ‹':'ni','ãƒŒ':'nu','ãƒ':'ne','ãƒ':'no','ãƒ':'ha','ãƒ’':'hi','ãƒ•':'fu','ãƒ˜':'he','ãƒ›':'ho','ãƒ':'ma','ãƒŸ':'mi','ãƒ ':'mu','ãƒ¡':'me','ãƒ¢':'mo','ãƒ¤':'ya','ãƒ¦':'yu','ãƒ¨':'yo','ãƒ©':'ra','ãƒª':'ri','ãƒ«':'ru','ãƒ¬':'re','ãƒ­':'ro','ãƒ¯':'wa','ãƒ²':'wo','ãƒ³':'n',
            'ã‚¬':'ga','ã‚®':'gi','ã‚°':'gu','ã‚²':'ge','ã‚´':'go','ã‚¶':'za','ã‚¸':'ji','ã‚º':'zu','ã‚¼':'ze','ã‚¾':'zo','ãƒ€':'da','ãƒ‚':'ji','ãƒ…':'zu','ë°':'de','ãƒ‰':'do','ãƒ':'ba','ãƒ“':'bi','ãƒ–':'bu','ãƒ™':'be','ãƒœ':'bo','ãƒ‘':'pa','ãƒ”':'pi','ãƒ—':'pu','ãƒš':'pe','ãƒ':'po'
        };

        // ë°ì´í„° ë³€í™˜ í•¨ìˆ˜ (ê°ì²´ -> ë°°ì—´ [{jp, pron, mean}])
        function convertToObjArray(rawData) {
            const arr = [];
            for (let key in rawData) {
                if(!key) continue;
                arr.push({ jp: key, pron: rawData[key], mean: rawData[key] }); // ë¬¸ìëŠ” ëœ»ë„ ë°œìŒê³¼ ë™ì¼ ì·¨ê¸‰
            }
            return arr;
        }

        const hiraganaData = convertToObjArray(hiraganaRaw);
        const katakanaData = convertToObjArray(katakanaRaw);

        // ë°ì´í„° ë³€ìˆ˜
        let currentMode = ''; 
        let currentDataList = []; // í˜„ì¬ ì„ íƒëœ ë°ì´í„° ë¦¬ìŠ¤íŠ¸ (ë°°ì—´)
        let sheetData = []; // ì‹œíŠ¸ ë°ì´í„°
        let studyType = ''; 
        let quizList = []; 
        let wrongList = []; 
        let currentIndex = 0; 
        let score = 0;
        const TEST_QUESTION_COUNT = 20;
        let isMuted = false; 
        let isProcessing = false; 
        let currentTestItem = null;

        // --- êµ¬ê¸€ ì‹œíŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ---
        async function loadSheetData() {
            if (GOOGLE_SHEET_URL.includes("ì—¬ê¸°ì—")) {
                alert("HTML íŒŒì¼ì„ ì—´ì–´ì„œ êµ¬ê¸€ ì‹œíŠ¸ CSV ë§í¬ë¥¼ ë„£ì–´ì£¼ì„¸ìš”!");
                return;
            }
            document.getElementById('loading-screen').style.display = 'flex';
            try {
                const response = await fetch(GOOGLE_SHEET_URL);
                const text = await response.text();
                sheetData = parseCSV(text);
                
                if (sheetData.length === 0) {
                    alert("ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš” ã… ã… ");
                    document.getElementById('loading-screen').style.display = 'none';
                    return;
                }
                currentDataList = sheetData;
                currentMode = 'sheet';
                document.getElementById('selected-mode-title').innerText = "ë‹¨ì–´ì¥ ëª¨ë“œ";
                document.getElementById('loading-screen').style.display = 'none';
                showScreen('mode-select-screen');
            } catch (error) {
                console.error(error);
                alert("êµ¬ê¸€ ì‹œíŠ¸ ì—°ê²° ì‹¤íŒ¨! ì¸í„°ë„·ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                document.getElementById('loading-screen').style.display = 'none';
            }
        }

        // CSV íŒŒì‹± (3ì—´ êµ¬ì¡°: jp, pron, mean)
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const data = [];
            lines.forEach(line => {
                // ë”°ì˜´í‘œ ë¬´ì‹œí•˜ê³  ì‰¼í‘œë¡œ ë¶„ë¦¬
                const parts = line.split(','); 
                if (parts.length >= 3) {
                    const jp = parts[0].trim().replace(/^"|"$/g, '');
                    const pron = parts[1].trim().replace(/^"|"$/g, '');
                    const mean = parts[2].trim().replace(/^"|"$/g, '');
                    if(jp && mean) data.push({ jp: jp, pron: pron, mean: mean });
                }
            });
            return data;
        }

        // --- ê¸°ë³¸ ë¡œì§ ---
        function toggleGlobalMute() {
            isMuted = !isMuted;
            const btn = document.getElementById('global-mute-btn');
            if (isMuted) {
                btn.innerText = 'ğŸ”‡';
                if(window.speechSynthesis) window.speechSynthesis.cancel();
            } else {
                btn.innerText = 'ğŸ”Š';
            }
        }

        function speakText(text) {
            if (isMuted) return;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ja-JP';
            utterance.rate = 0.8;
            window.speechSynthesis.speak(utterance);
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function goHome() {
            if(confirm("ì •ë§ ì²˜ìŒ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°ˆê¹Œìš”?")) {
                showScreen('start-screen');
                if(window.speechSynthesis) window.speechSynthesis.cancel();
            }
        }

        function selectCharType(type) {
            currentMode = type;
            if (type === 'hiragana') {
                currentDataList = hiraganaData;
                document.getElementById('selected-mode-title').innerText = "íˆë¼ê°€ë‚˜";
            } else {
                currentDataList = katakanaData;
                document.getElementById('selected-mode-title').innerText = "ì¹´íƒ€ì¹´ë‚˜";
            }
            showScreen('mode-select-screen');
        }

        function gotoQuantitySelect() { showScreen('quantity-select-screen'); }

        // --- ê³µë¶€ ëª¨ë“œ (ì¹´ë“œ) ---
        function startStudy(amount) {
            studyType = 'study';
            // ë³µì‚¬í•´ì„œ ì„ê¸°
            let temp = [...currentDataList];
            temp.sort(() => Math.random() - 0.5);

            if (amount === 'all') quizList = temp; 
            else quizList = temp.slice(0, parseInt(amount)); 
            
            wrongList = []; currentIndex = 0; score = 0;
            updateStudyScreen(); showScreen('study-screen');
        }

        function updateStudyScreen() {
            if (currentIndex >= quizList.length) { finishGame(); return; }
            const item = quizList[currentIndex];
            
            // [NEW] 3ë‹¨ êµ¬ì¡° í‘œì‹œ
            document.getElementById('study-jp').innerText = item.jp;
            document.getElementById('study-pron').innerText = item.pron;
            
            document.getElementById('study-progress').innerText = `${currentIndex + 1} / ${quizList.length}`;
            
            const meanDisplay = document.getElementById('study-meaning');
            meanDisplay.style.visibility = 'hidden'; 
            meanDisplay.innerText = '';
        }

        function playSoundAndShowText() {
            const item = quizList[currentIndex];
            const meanDisplay = document.getElementById('study-meaning');
            meanDisplay.innerText = item.mean; // ëœ» ë³´ì—¬ì£¼ê¸°
            meanDisplay.style.visibility = 'visible';
            speakText(item.jp); // ì¼ë³¸ì–´ ì½ê¸°
        }

        function checkStudyAnswer(isCorrect) {
            const item = quizList[currentIndex];
            if (isCorrect) score++; else wrongList.push(item);
            currentIndex++; updateStudyScreen();
        }

        // --- ì‹œí—˜ ëª¨ë“œ (ê°ê´€ì‹) ---
        function startTest() {
            studyType = 'test'; isProcessing = false;
            let temp = [...currentDataList];
            temp.sort(() => Math.random() - 0.5);
            
            const qCount = Math.min(TEST_QUESTION_COUNT, temp.length);
            quizList = temp.slice(0, qCount);
            
            wrongList = []; currentIndex = 0; score = 0;
            renderTestQuestion(); showScreen('test-screen');
        }

        function renderTestQuestion() {
            if (currentIndex >= quizList.length) { finishGame(); return; }
            isProcessing = false; 
            const correctItem = quizList[currentIndex];
            currentTestItem = correctItem;
            
            // [NEW] ë¬¸ì œ í‘œì‹œ (ë°œìŒ ì‘ê²Œ, ì¼ë³¸ì–´ í¬ê²Œ)
            document.getElementById('test-pron').innerText = correctItem.pron;
            document.getElementById('test-jp').innerText = correctItem.jp;
            
            document.getElementById('test-progress').innerText = `${currentIndex + 1} / ${quizList.length}`;

            // ì˜¤ë‹µ ë³´ê¸° ìƒì„± (ëœ»ì„ ë³´ì—¬ì¤Œ)
            let options = [correctItem];
            if (currentDataList.length >= 3) {
                while (options.length < 3) {
                    const randomItem = currentDataList[Math.floor(Math.random() * currentDataList.length)];
                    // ì¤‘ë³µ ë°©ì§€ (ì¼ë³¸ì–´ê°€ ë‹¤ë¥´ë©´ ë‹¤ë¥¸ ë¬¸ì œë¡œ ê°„ì£¼)
                    if (!options.some(opt => opt.jp === randomItem.jp)) options.push(randomItem);
                }
            } else {
                options = [...currentDataList]; // ë°ì´í„°ê°€ ì ìœ¼ë©´ ìˆëŠ” ê²ƒë§Œ
            }
            options.sort(() => Math.random() - 0.5);

            const container = document.getElementById('options-container');
            container.innerHTML = '';
            options.forEach(item => {
                const btn = document.createElement('button');
                btn.className = 'btn-option';
                btn.innerText = item.mean; // ë²„íŠ¼ì—ëŠ” 'ëœ»'ì„ í‘œì‹œ
                btn.onclick = () => checkTestAnswer(item, correctItem);
                container.appendChild(btn);
            });
        }

        function playTestSound() { if(currentTestItem) speakText(currentTestItem.jp); }

        function checkTestAnswer(selectedItem, correctItem) {
            if (isProcessing) return; isProcessing = true;
            const isCorrect = (selectedItem.jp === correctItem.jp);
            
            if (isCorrect) { score++; showFeedback(true); } 
            else { wrongList.push(correctItem); showFeedback(false); }
            
            setTimeout(() => { currentIndex++; renderTestQuestion(); }, 800); 
        }

        function showFeedback(isCorrect) {
            const box = document.getElementById('feedback-box');
            if (isCorrect) {
                box.innerText = "ì •ë‹µ! â­•"; box.style.color = "green"; box.style.borderColor = "green";
            } else {
                box.innerText = "ë•¡! âŒ"; box.style.color = "red"; box.style.borderColor = "red";
            }
            box.style.display = 'flex'; 
            setTimeout(() => { box.style.display = 'none'; }, 800);
        }

        function finishGame() {
            if(window.speechSynthesis) window.speechSynthesis.cancel();
            const total = quizList.length;
            const finalScore = total === 0 ? 0 : Math.round((score / total) * 100);
            document.getElementById('score-count').innerText = `ë§ì€ ê°œìˆ˜: ${score} / ${total}`;
            
            let message = "", color = "#333";
            if (finalScore === 100) { message = "ì™„ë²½í•´ìš”! ë‹¹ì‹ ì€ ì¼ë³¸ì–´ ì²œì¬ì•¼! ğŸ‰"; color = "#32CD32"; }
            else if (finalScore >= 80) { message = "ëŒ€ë‹¨í•´! ì•„ì£¼ ì¡°ê¸ˆë§Œ ë” í•˜ë©´ ë§Œì ì´ì•¼! ğŸ”¥"; color = "#1E90FF"; }
            else if (finalScore >= 60) { message = "ì˜í–ˆì–´! í•©ê²©ì ì´ì•¼! ğŸ‘"; color = "#00CED1"; }
            else if (finalScore >= 40) { message = "ì ˆë°˜ì€ ë„˜ì—ˆì–´! ì¡°ê¸ˆë§Œ ë” í˜ë‚´ì! ğŸ’ª"; color = "#FFA500"; }
            else if (finalScore >= 20) { message = "ì•„ì§ í—·ê°ˆë¦¬ëŠ” ê²Œ ë§êµ¬ë‚˜... ë³µìŠµ í•„ìˆ˜! ğŸ“š"; color = "#FF6347"; }
            else if (finalScore > 0) { message = "ì´ì œ ì‹œì‘ì´ì•¼! í¬ê¸°í•˜ì§€ ë§ˆ! ğŸŒ±"; color = "#FF4500"; }
            else { message = "0ì ì´ë¼ë‹ˆ... ì°ì–´ë„ ì´ê²ƒë³´ë‹¨ ì˜ ë‚˜ì˜¤ê² ë‹¤! ğŸ˜­"; color = "red"; }

            const gradeMsg = document.getElementById('grade-msg');
            gradeMsg.innerText = message; gradeMsg.style.color = color;
            document.getElementById('final-score').innerText = `${finalScore} ì `;

            if (wrongList.length > 0) document.getElementById('wrong-msg').style.display = 'block';
            else document.getElementById('wrong-msg').style.display = 'none';
            showScreen('result-screen');
        }

        function openWrongList() {
            const tbody = document.getElementById('wrong-table-body');
            tbody.innerHTML = '';
            document.getElementById('wrong-count-display').innerText = `ì´ ${wrongList.length}ê°œ í‹€ë¦¼`;
            wrongList.forEach(item => {
                const tr = document.createElement('tr');
                // ì˜¤ë‹µë…¸íŠ¸ì—ë„ 3ë‹¨ ì •ë³´ í‘œì‹œ (ë‹¨ì–´ / ë°œìŒ / ëœ»)
                tr.innerHTML = `<td>${item.jp}</td><td>${item.pron}</td><td>${item.mean}</td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('wrong-list-popup').style.display = 'flex';
            document.querySelector('.popup-scroll-area').scrollTop = 0;
        }

        function closeWrongList() { document.getElementById('wrong-list-popup').style.display = 'none'; }
    </script>
</body>
</html>